/**
 * POS Page (Server Component)
 * Fetches products and inventory for the current user's store
 * Passes data to POSClient for rendering
 */

import { createClient } from '@/lib/supabase/server'
import { redirect } from 'next/navigation'
import { POSClient } from '@/components/pos/pos-client'

export const metadata = {
  title: 'Point of Sale | Next-Stock',
  description: 'Point of sale checkout system',
}

export default async function POSPage() {
  const supabase = await createClient()

  // Get current user
  const {
    data: { user },
  } = await supabase.auth.getUser()

  if (!user) {
    redirect('/auth/login')
  }

  // Get user profile with store information
  const { data: profile, error: profileError } = await supabase
    .from('profiles')
    .select('id, store_id, role, full_name, store:stores(id, name)')
    .eq('id', user.id)
    .single()

  if (profileError || !profile || !profile.store_id) {
    return (
      <div className="flex h-[80vh] items-center justify-center">
        <div className="text-center">
          <h2 className="text-2xl font-bold text-gray-900">No Store Assigned</h2>
          <p className="mt-2 text-gray-600">
            You need to be assigned to a store to use the POS system.
          </p>
          <p className="mt-1 text-sm text-gray-500">Contact your administrator.</p>
        </div>
      </div>
    )
  }

  // Fetch products with inventory for current store
  const { data: products, error: productsError } = await supabase
    .from('product_templates')
    .select(
      `
      id,
      sku,
      name,
      price,
      barcode,
      category:categories(id, name),
      inventory:product_inventory!product_inventory_product_id_fkey(
        id,
        quantity,
        store_id
      )
    `
    )
    .eq('is_active', true)
    .eq('inventory.store_id', profile.store_id)
    .order('name')

  if (productsError) {
    console.error('Error fetching products:', productsError)
    return (
      <div className="flex h-[80vh] items-center justify-center">
        <div className="text-center">
          <h2 className="text-2xl font-bold text-red-600">Error Loading Products</h2>
          <p className="mt-2 text-gray-600">{productsError.message}</p>
        </div>
      </div>
    )
  }

  // Transform products to include only current store's inventory
  const productsWithInventory = products
    ?.map((product) => {
      const storeInventory = product.inventory.find(
        (inv: { store_id: string }) => inv.store_id === profile.store_id
      )

      if (!storeInventory) return null

      return {
        id: product.id,
        sku: product.sku,
        name: product.name,
        price: Number(product.price),
        barcode: product.barcode || '',
        category: product.category,
        inventoryId: storeInventory.id,
        quantity: storeInventory.quantity,
      }
    })
    .filter((p): p is NonNullable<typeof p> => p !== null) || []

  return (
    <div className="h-[calc(100vh-4rem)] overflow-hidden">
      <POSClient
        products={productsWithInventory}
        storeId={profile.store_id}
        storeName={profile.store?.name || 'Store'}
        cashierId={user.id}
        cashierName={profile.full_name || 'User'}
      />
    </div>
  )
}
